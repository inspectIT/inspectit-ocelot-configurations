# Extends tracing with additional tags for spring data repository profiling.

inspectit:
  instrumentation:

    scopes:
      's_spring_qemi':
        type:
          name: org.springframework.data.repository.core.support.RepositoryFactorySupport$QueryExecutorMethodInterceptor
        methods:
          - name: invoke

    actions:
      'a_spring_qemi_method_name':
        imports:
          - org.aopalliance.intercept
          - java.lang.reflect
        input:
          _arg0: MethodInvocation
        value-body: |
          Method method = _arg0.getMethod();
          return method.getName();

      'a_spring_qemi_method_clazz':
        imports:
          - org.aopalliance.intercept
          - java.lang.reflect
        input:
          _arg0: MethodInvocation
        value-body: |
          Method method = _arg0.getMethod();
          return method.getDeclaringClass();

      'a_spring_qemi_nice_method_clazz':
        imports:
          - org.aopalliance.intercept
          - java.lang.reflect
        input:
          _arg0: MethodInvocation
        value-body: |
          Method method = _arg0.getMethod();
          return method.getDeclaringClass().getSimpleName() + "." + method.getName();

    rules:
      'r_spring_data_tracing':
        scopes:
          's_spring_qemi': true
        tracing:
          start-span: true
          name: nicename
          attributes:
            target_class: tclass
            target_method: tmethod
        entry:
          tclass:
            action: 'a_spring_qemi_method_clazz'
          tmethod:
            action: 'a_spring_qemi_method_name'
          nicename:
            action: 'a_spring_qemi_nice_method_clazz'
